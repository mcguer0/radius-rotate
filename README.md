# Radius Rotate

Массовое создание и ротация пользователей FreeRADIUS/daloRADIUS по списку префиксов.

Скрипт для каждого заданного префикса создает заданное количество учётных записей с безопасными логинами/паролями и временем истечения, а также (по желанию) удаляет просроченные учётки для этих префиксов. Поддерживается интерактивная настройка параметров и хранение конфигурации в файле `config.json`.

## Возможности

- Генерация учётных записей:
  - `username = <PREFIX><32 случайных символа [a-zA-Z0-9]>`
  - `password = 64 случайных символов` (буквы, цифры, знак препинания)
  - `Expiration = +N месяцев` в формате `DD Mon YYYY HH:MM:SS` (локальное время)
- Количество создаваемых аккаунтов на каждый префикс настраивается (`RADIUS_COUNT_PER_PREFIX`).
- Удаление просроченных учеток (по желанию) для заданных префиксов.
- Опционально присваивает группу (`radusergroup`).
- Опционально добавляет запись в `userinfo` (если таблица существует).
- Интерактивная настройка и валидация подключения к БД и схемы.

## Требования

- Python 3.8+
- Библиотека `pymysql`

Установка зависимостей:

```
pip install pymysql
```

## Быстрый старт

1) Запустите интерактивный мастер настройки и сохраните конфигурацию:

```
python rotate.py -config
```

Во время настройки укажите параметры подключения к MySQL, список префиксов, количество аккаунтов на префикс, срок действия, режим удаления просроченных и пр. Скрипт проверит подключение и наличие обязательных таблиц.

2) Выполните ротацию:

```
python rotate.py
```

Скрипт создаст новые учётные записи и удалит просроченные (если включено).

## Конфигурация

Конфигурация хранится в `config.json` (путь можно переопределить через переменную окружения `RADIUS_CONFIG_FILE`). Значения можно переопределять переменными окружения — они имеют приоритет над файлом.

Поддерживаемые параметры:

- `RADIUS_DB_HOST` (str): хост БД, по умолчанию `127.0.0.1`.
- `RADIUS_DB_PORT` (int): порт БД, по умолчанию `3306`.
- `RADIUS_DB_USER` (str): пользователь БД.
- `RADIUS_DB_PASS` (str): пароль БД.
- `RADIUS_DB_NAME` (str): база данных.
- `RADIUS_PREFIXES` (list | str): список префиксов (список или строка через запятую).
- `RADIUS_COUNT_PER_PREFIX` (int): сколько аккаунтов создавать на каждый префикс (>=1).
- `RADIUS_EXPIRE_MONTHS` (int): срок действия в месяцах (1..120).
- `RADIUS_DELETE_EXPIRED` (bool): удалять просроченные (`true/false`, `1/0`).
- `RADIUS_ENABLE_GROUP` (bool): назначать ли группу.
- `RADIUS_GROUP_NAME` (str): имя группы (если включено назначение).
- `RADIUS_FILL_USERINFO` (bool): добавлять запись в `userinfo` (если таблица существует).
- `RADIUS_PASS_PUNCT` (str | null): набор знаков препинания для генерации пароля. Пустая строка/`null` — использовать стандартный `string.punctuation` из Python.

Совместимость: для обратной совместимости поддерживается старый ключ `RADIUS_PREFIX` (один префикс).

Пример `config.json`:

```json
{
  "RADIUS_DB_HOST": "127.0.0.1",
  "RADIUS_DB_PORT": 3306,
  "RADIUS_DB_USER": "radius",
  "RADIUS_DB_PASS": "secret",
  "RADIUS_DB_NAME": "radiusdb",
  "RADIUS_PREFIXES": ["wifi-", "corp_"],
  "RADIUS_COUNT_PER_PREFIX": 2,
  "RADIUS_EXPIRE_MONTHS": 1,
  "RADIUS_DELETE_EXPIRED": true,
  "RADIUS_ENABLE_GROUP": true,
  "RADIUS_GROUP_NAME": "default",
  "RADIUS_FILL_USERINFO": true,
  "RADIUS_PASS_PUNCT": "!#$%&()*+,-./:;<=>?@[]^_{|}~"
}
```

## Валидатор конфигурации

Интерактивный мастер проверяет:

- Корректность значений (`port`, `months`, `count >= 1`, непустые хост/логин/БД и др.).
- Наличие обязательной таблицы `radcheck` в БД.
- Если включено назначение группы — наличие таблицы `radusergroup`.
- Подключение к БД (выполняется `SELECT 1`).

При обнаружении ошибок мастер предложит повторить ввод. Можно сохранить конфигурацию с предупреждениями, но запуск без исправления ошибок может завершиться неудачно.

## Управление пользователями (меню)

Запустите:

```
python rotate.py -manage
```

Возможности меню по выбранному префиксу:

- Показать пользователей (выведет до 50 первых, а также количество найденных).
- Удалить пользователя по точному `username` (удаляет из `radcheck`, `radreply`, `radusergroup`, `userinfo`).
- Удалить все просроченные для этого префикса.
- Изменить срок действия конкретного пользователя (в месяцах). Значение `0` — делает учётку просроченной немедленно.
- Массово изменить срок действия всем пользователям с этим префиксом.

## Планировщик (Debian cron)

Интерактивная установка задания в планировщике:

```
python rotate.py -schedule
```

Мастер предложит выбрать частоту (ежедневно, ежечасно, каждые N минут, еженедельно, ежемесячно или произвольная cron-строка) и путь к лог-файлу. Скрипт добавит или обновит запись в crontab текущего пользователя с тегом `RADIUS_ROTATE_AUTO` и командой вида:

```
<cron-time> cd /path/to/dir && RADIUS_CONFIG_FILE=/path/to/config.json python3 rotate.py >> /var/log/radius-rotate.log 2>&1 # RADIUS_ROTATE_AUTO
```

Примечания:

- Работает на Linux/Debian с установленной утилитой `crontab` (пакет `cron`).
- Путь к Python определяется автоматически (`python3` или текущий интерпретатор).
- Для нестандартного пути к конфигу используйте `RADIUS_CONFIG_FILE`.

## Использование переменных окружения

Любой параметр можно задать через переменную окружения (приоритетнее файла):

```
RADIUS_DB_HOST=10.0.0.5 RADIUS_PREFIXES="wifi-,corp_" python rotate.py
```

Путь к файлу конфигурации:

```
RADIUS_CONFIG_FILE=/etc/radius-rotate.json python rotate.py -config
```

## Поведение скрипта

- Создание: для каждого префикса создается `RADIUS_COUNT_PER_PREFIX` учёток.
- Удаление: если `RADIUS_DELETE_EXPIRED=true`, скрипт находит и удаляет просроченные учётки (по их `Expiration`) только среди заданных префиксов.
- Группа: при `RADIUS_ENABLE_GROUP=true` добавляется запись в `radusergroup` с приоритетом `1`.
- Userinfo: при `RADIUS_FILL_USERINFO=true` создается запись в `userinfo` (если таблица существует). Отсутствие `userinfo` не является ошибкой — будет пропущено.

## Ключи запуска

- `-config`/`--config`: интерактивная настройка и сохранение конфигурации (с валидацией и проверкой БД).
- `-manage`/`--manage`: интерактивное управление пользователями по префиксам (удаление/изменение срока).
- `-schedule`/`--schedule`: установка задания в планировщик Debian cron.

## Частые ошибки и диагностика

- Ошибка подключения к БД: проверьте хост/порт/учетные данные и сетевую доступность.
- Нет таблицы `radcheck`: проверьте схему FreeRADIUS/daloRADIUS в выбранной БД.
- Включено назначение группы, но нет `radusergroup`: либо создайте таблицу, либо отключите опцию.
- `Префиксы пустые`: задайте хотя бы один префикс (например, `wifi-`).

## Замечания по безопасности

- Файл `config.json` содержит пароль к БД. Ограничьте права доступа к файлу.
- Пароли пользователей генерируются случайно (используется `secrets`). Можно задать разрешенный набор знаков препинания через `RADIUS_PASS_PUNCT`.

## Лицензия

Без указания.
